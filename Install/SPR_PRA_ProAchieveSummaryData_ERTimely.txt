CREATE PROCEDURE SPR_PRA_ProAchieveSummaryData_ERTimely
	@ProviderRef NVARCHAR(50),
	@AcademicYear NVARCHAR(5),
	@CollegeType INT,
	@ProGeneralDatabaseLocation NVARCHAR(200),
	@ProAchieveDatabaseLocation NVARCHAR(200),
	@OutputTableLocation NVARCHAR(200),
	@FacStructureLevel INT,
	@TeamStructureLevel INT,
	@CostCentreStructureLevel INT,
	@UserDefinedTrueValue NVARCHAR(50),
	@ALSUserDefinedField INT,
	@LookedAfterUserDefinedField INT,
	@CareLeaverUserDefinedField INT,
	@YoungCarerUserDefinedField INT,
	@YoungParentUserDefinedField INT,
    @NumRowsChanged INT OUTPUT, 
	@ErrorCode INT OUTPUT
AS
BEGIN
	SET NOCOUNT ON;

	--DECLARE @AcademicYear NVARCHAR(7) = '18/19'
	--DECLARE @CollegeType INT = 2
	--DECLARE @ProGeneralDatabaseLocation NVARCHAR(200) = 'ussql01.ProGeneral.dbo.'
	--DECLARE @ProAchieveDatabaseLocation NVARCHAR(200) = 'ussql01.ProAchieve.dbo.'
	--DECLARE @FacStructureLevel INT = 2
	--DECLARE @TeamStructureLevel INT = 3
	--DECLARE @CostCentreStructureLevel INT = 4

	DECLARE @SQLString NVARCHAR(MAX);
	DECLARE @SQLParams NVARCHAR(MAX);

    SET @SQLString = 
        N'
		INSERT INTO ' + @OutputTableLocation + 'PRA_ProAchieveSummaryData WITH (TABLOCKX)
		SELECT
			EndYear = ER.PG_ExpEndYrID,
			AcademicYear = AY.PG_AcademicYearID,
			SummaryType =
                ''ER_Timely_''
                + CASE
                    WHEN 
                        MYS.DefaultSummary = 1
                        AND MYS.IsArchived = 0
                        AND MYS.IsQSRSummary = 0
                        AND MYS.RulesApplied = 0
                        AND MYS.IncludeAllAimTypes = 1
                        THEN ''AllAims''
                    WHEN 
                        MYS.DefaultSummary = 0
                        AND MYS.IsArchived = 0
                        AND MYS.IsQSRSummary = 1
                        AND MYS.RulesApplied = 0
                        AND MYS.IncludeAllAimTypes = 1
                        THEN ''QAR''
                    ELSE ''ERROR''
                END,
			DefaultSummary = MYS.DefaultSummary,
			ProviderID = MYS.PG_ProviderID,
			ProviderRef = @ProviderRef,
			ProviderName = MYS.PG_ProviderName,
			Summary = MYS.Description,
			SummaryStatus = MYS.Status,
			AcademicYears = MYS.ER_MYSName,
			NumYears = MYS.Years,
			LastAcademicYear = MYS.LastAcademicYearID,
			RulesApplied = MYS.RulesApplied,
			LastUpdated = MYS.LastUpdated,

			LearnerRef = ER.PG_StudentID,
			LearnerName = STU.Surname + '', '' + STU.Forenames,
			Gender = ER.PG_SexID,
			AgeGroup = 
				CASE
					WHEN AGE.PG_WBLFundAgeGroupName = ''24+'' THEN ''24 +''
					ELSE AGE.PG_WBLFundAgeGroupName
				END,
			EthnicityCode = ETH.PG_EthnicityID,
			EthnicityName = ETH.PG_EthnicityName,
			EthnicityOrder = ETH.PG_EthnicityOrder,
			EthnicGroupCode = ETHG.PG_EthnicGroupID,
			EthnicGroupName = ETHG.PG_EthnicGroupName,
			EthnicGroupOrder = ETHG.PG_EthnicGroupOrder,
			EthnicGroupQARCode = ETHQ.PG_EthnicityGroupQARID,
			EthnicGroupQARName = ETHQ.PG_EthnicityGroupQARName,
			EthnicGroupQAROrder = ETHQ.PG_EthnicityGroupQAROrder,
			EthnicGroupSimpleCode = ETHGS.PG_EthnicGroupSimpleID,
			EthnicGroupSimpleName = ETHGS.PG_EthnicGroupSimpleName,
			EthnicGroupSimpleOrder = ETHGS.PG_EthnicGroupSimpleOrder,
			DiffDissCode = ER.PG_DifficultyOrDisabilityID,
			DiffDissName = DIF.ShortDescription,
			IsHighNeeds = COALESCE ( FAM.PG_LearnFAMTypeHNSID, 0 ),
			IsFreeMealsEligible = CASE WHEN FAM.PG_LearnFAMTypeFMEID IS NOT NULL THEN 1 ELSE 0 END,
	'
    
    SET @SQLString += 
        N'
			IsALSRequired = 
				CASE 
					WHEN
						CASE 
							WHEN @ALSUserDefinedField = 1 THEN STU.UserDefined1
							WHEN @ALSUserDefinedField = 2 THEN STU.UserDefined2
							WHEN @ALSUserDefinedField = 3 THEN STU.UserDefined3
							WHEN @ALSUserDefinedField = 4 THEN STU.UserDefined4
							WHEN @ALSUserDefinedField = 5 THEN STU.UserDefined5
						END
					= @UserDefinedTrueValue THEN 1 
					ELSE 0 
				END,
			IsLookedAfter = 
				CASE 
					WHEN
						CASE 
							WHEN @LookedAfterUserDefinedField = 1 THEN STU.UserDefined1
							WHEN @LookedAfterUserDefinedField = 2 THEN STU.UserDefined2
							WHEN @LookedAfterUserDefinedField = 3 THEN STU.UserDefined3
							WHEN @LookedAfterUserDefinedField = 4 THEN STU.UserDefined4
							WHEN @LookedAfterUserDefinedField = 5 THEN STU.UserDefined5
						END
					= @UserDefinedTrueValue THEN 1 
					ELSE 0 
				END,
			IsCareLeaver = 
				CASE 
					WHEN
						CASE 
							WHEN @CareLeaverUserDefinedField = 1 THEN STU.UserDefined1
							WHEN @CareLeaverUserDefinedField = 2 THEN STU.UserDefined2
							WHEN @CareLeaverUserDefinedField = 3 THEN STU.UserDefined3
							WHEN @CareLeaverUserDefinedField = 4 THEN STU.UserDefined4
							WHEN @CareLeaverUserDefinedField = 5 THEN STU.UserDefined5
						END
					= @UserDefinedTrueValue THEN 1 
					ELSE 0 
				END,
			IsYoungCarer = 
				CASE 
					WHEN
						CASE 
							WHEN @YoungCarerUserDefinedField = 1 THEN STU.UserDefined1
							WHEN @YoungCarerUserDefinedField = 2 THEN STU.UserDefined2
							WHEN @YoungCarerUserDefinedField = 3 THEN STU.UserDefined3
							WHEN @YoungCarerUserDefinedField = 4 THEN STU.UserDefined4
							WHEN @YoungCarerUserDefinedField = 5 THEN STU.UserDefined5
						END
					= @UserDefinedTrueValue THEN 1 
					ELSE 0 
				END,
			IsYoungParent = 
				CASE 
					WHEN
						CASE 
							WHEN @YoungParentUserDefinedField = 1 THEN STU.UserDefined1
							WHEN @YoungParentUserDefinedField = 2 THEN STU.UserDefined2
							WHEN @YoungParentUserDefinedField = 3 THEN STU.UserDefined3
							WHEN @YoungParentUserDefinedField = 4 THEN STU.UserDefined4
							WHEN @YoungParentUserDefinedField = 5 THEN STU.UserDefined5
						END
					= @UserDefinedTrueValue THEN 1 
					ELSE 0 
				END,
	'

    SET @SQLString += 
        N'
			CampusID = COALESCE ( STU.CampusID, ''-'' ),
			FacCode = 
				COALESCE ( 
					CASE 
						WHEN @FacStructureLevel = 1 THEN L1.GN_Structure1IYID
						WHEN @FacStructureLevel = 2 THEN L2.GN_Structure2IYID
						WHEN @FacStructureLevel = 3 THEN L3.GN_Structure3IYID
						WHEN @FacStructureLevel = 4 THEN L4.GN_Structure4IYID
					END,
					''-''
				),
			FacName = 
				COALESCE ( 
					CASE 
						WHEN @FacStructureLevel = 1 THEN L1.GN_Structure1IYName
						WHEN @FacStructureLevel = 2 THEN L2.GN_Structure2IYName
						WHEN @FacStructureLevel = 3 THEN L3.GN_Structure3IYName
						WHEN @FacStructureLevel = 4 THEN L4.GN_Structure4IYName
					END,
					''-- Unknown --''
				),
			TeamCode = 
				COALESCE ( 
					CASE 
						WHEN @TeamStructureLevel = 1 THEN L1.GN_Structure1IYID
						WHEN @TeamStructureLevel = 2 THEN L2.GN_Structure2IYID
						WHEN @TeamStructureLevel = 3 THEN L3.GN_Structure3IYID
						WHEN @TeamStructureLevel = 4 THEN L4.GN_Structure4IYID
					END,
					''-''
				),
			TeamName = 
				COALESCE ( 
					CASE 
						WHEN @TeamStructureLevel = 1 THEN L1.GN_Structure1IYName
						WHEN @TeamStructureLevel = 2 THEN L2.GN_Structure2IYName
						WHEN @TeamStructureLevel = 3 THEN L3.GN_Structure3IYName
						WHEN @TeamStructureLevel = 4 THEN L4.GN_Structure4IYName
					END,
					''-- Unknown --''
				),
			CostCentreCode = 
				COALESCE ( 
					CASE 
						WHEN @CostCentreStructureLevel = 1 THEN L1.GN_Structure1IYID
						WHEN @CostCentreStructureLevel = 2 THEN L2.GN_Structure2IYID
						WHEN @CostCentreStructureLevel = 3 THEN L3.GN_Structure3IYID
						WHEN @CostCentreStructureLevel = 4 THEN L4.GN_Structure4IYID
					END,
					''-''
				),
			CostCentreName = 
				COALESCE ( 
					CASE 
						WHEN @CostCentreStructureLevel = 1 THEN L1.GN_Structure1IYName
						WHEN @CostCentreStructureLevel = 2 THEN L2.GN_Structure2IYName
						WHEN @CostCentreStructureLevel = 3 THEN L3.GN_Structure3IYName
						WHEN @CostCentreStructureLevel = 4 THEN L4.GN_Structure4IYName
					END,
					''-- Unknown --''
				),
			SSA1Code = ER.PG_SSA1ID,
			SSA1Name = SSA1.SSA_Tier1_Desc,
			SSA2Code = ER.PG_SSA2ID,
			SSA2Name = SSA2.SSA_Tier2_Desc,
			ProgTypeCode = ER.PG_ProgTypeID,
			ProgTypeShortName = PT.PG_ProgTypeShortName,
			ProgTypeName = PT.PG_ProgTypeName,
			StandardCode = ER.PG_AppStandardID,
			StandardName = STD.PG_AppStandardName,
			FrameworkCode = ER.PG_FrameworkID,
			FrameworkName = FWK.PG_FrameworkName,
			CourseCode = ER.PG_AggCourseID,
			CourseName = CRS.PG_AggCourseName,
			GroupCode = ER.EnrolmentUserDefined1,
			SubcontractorCode = ER.PG_SubContractorID,
			SubcontractorName = NULL,
			MinimumStandardGroupCode = ER.Minimum_Standards_GroupID,
			MinimumStandardsGroupName = MSTD.Minimum_Standards_GroupName,
			SequenceNo = ER.SequenceNo,
	'

    SET @SQLString += 
        N'
			AimRef = AIM.GN_AimID,
			AimName = AIM.GN_AimName,
			QualTypeCode = ER.PG_QualSizeID,
			QualTypeName = QS.PG_QualSizeName,
			LARSAimTypeCode = NULL,
			LARSAimTypeName = NULL,
			AimTypeCode = ER.PG_ILRAimTypeID,
			AimTypeName = NULL,
			DurationCode = ER.WB_DurationID,
			DurationName = DUR.WB_DurationName,
			DurationGroupCode = NULL,
			DurationGroupName = NULL,
			DurationTypeCode = NULL,
			DurationTypeName = NULL,
			DurationTypeGroupCode = NULL,
			DurationTypeGroupName = NULL,

			EngOrMathsCode = ''X'',
			EngOrMathsName = ''Neither'',
			NVQLevelCode = NVQ.PG_NVQLevelCPRID,
			NVQLevelName = NVQ.PG_NVQLevelCPRName,
			NVQLevelGrpCode = NVQG.NVQLevelGroupID,
			NVQLevelGrpName = NVQG.Description,
			AwardBody = AIM.PG_AwardBodyID,
			Grade = NULL,

			FundModelCode = ''APP'',
			FundModelName = ''Apprenticeship'',
			IsEFAFunded = 0,
			IsAdvLearnLoanFunded = 0,
			IsStart = 
				WBCount 
				- 
				CASE
					WHEN ER.WBCount = 0 THEN 0
					WHEN ER.WBXfr + ER.WBWithdrawnin6Wks + ER.WBPlannedBreak > 0  THEN 1
				ELSE 0
				END,
			IsLeaver = 
				WBLeave 
				- 
				CASE 
					WHEN ER.WBLeave = 0 THEN 0
					WHEN ER.WBLSCExcludeTimely + ER.WBWithdrawnin6Wks > 0 THEN 1
					ELSE 0
				END 
				+ 
				CASE 
					WHEN COALESCE ( ER.WBCont, 0 ) = 0 THEN 0
					WHEN ER.WBLSCExcludeTimely + ER.WBWithdrawnin6Wks > 0 THEN 0
					ELSE 1
				END,
			LessonsExpected = ER.Att_Exp,
			LessonsAttended = ER.Att_Act,
			AttendPer = 
				ROUND (
					CASE
						WHEN ER.Att_Exp = 0 THEN 0
						ELSE CAST ( ER.Att_Act AS FLOAT ) / CAST ( ER.Att_Exp AS FLOAT )
					END
				, 4 ),
			LessonsLate = ER.Att_Lat,
			PuncPer = 
				ROUND (
					CASE
						WHEN ER.Att_Act = 0 THEN 0
						ELSE 100 - CAST ( ER.Att_Lat AS FLOAT ) / CAST ( ER.Att_Act AS FLOAT )
					END
				, 4 ),
			IsXfr = ER.WBXfr,
			IsCont = ER.WBCont,
			IsWdr = ER.WBLeave,
			IsWdrInQualifyingPeriod = ER.WBWithdrawnin6Wks,
			IsWdrAfterQualifyingPeriod = 
				CASE
					WHEN ER.WBWithdrawnFlag - ER.WBWithdrawnin6Wks > 0 THEN 1
					ELSE 0
				END,
			IsOutOfFunding30 = 
				CASE
					WHEN ER.WBContinBeyondEndTimely = 1 THEN
						CASE
							WHEN DATEDIFF ( DAY, ER.PlannedEndDate, CAST ( GetDate() AS DATE ) ) <= 30 THEN 1
							ELSE 0
						END
					ELSE 0
				END,
			IsOutOfFunding60 = 
				CASE
					WHEN ER.WBContinBeyondEndTimely = 1 THEN
						CASE
							WHEN DATEDIFF ( DAY, ER.PlannedEndDate, CAST ( GetDate() AS DATE ) ) BETWEEN 31 AND 60 THEN 1
							ELSE 0
						END
					ELSE 0
				END,
			IsOutOfFunding90 = 
				CASE
					WHEN ER.WBContinBeyondEndTimely = 1 THEN
						CASE
							WHEN DATEDIFF ( DAY, ER.PlannedEndDate, CAST ( GetDate() AS DATE ) ) BETWEEN 61 AND 90 THEN 1
							ELSE 0
						END
					ELSE 0
				END,
			IsComp = ER.WBRet - ER.WBCont,
			IsRetInYr = 
				CASE
					WHEN ER.WBOverdue = 1 AND ER.WB_FrameworkStatusID IN (0,5) THEN 0
					ELSE ER.WBRet
				END,
			IsRet = 
				CASE
					WHEN ER.WBOverdue = 1 AND ER.WB_FrameworkStatusID IN (0,5) THEN 0
					ELSE ER.WBRet
				END,
			IsAch = 
				ER.WBAchFrameTimely 
				- 
				CASE 
					WHEN ER.WBAchFrameTimely = 0 THEN 0
					ELSE ER.WBLSCExcludeTimely
				END,
			IsPassAToC = 0,
	'

    SET @SQLString += 
        N'
			NatRate_Yr_Leave = NR_YR.BMLeave,
			NatRate_Yr_Comp = NULL,
			NatRate_Yr_RetPer = NULL,
			NatRate_Yr_Ach = NR_YR.BMAchFrameTimely,
			NatRate_Yr_AchPer = CAST ( NR_YR.BMAchFrameTimelyLeave AS FLOAT ) / 100.00,
			NatRate_YrALL_Leave = NR_YRA.BMLeave,
			NatRate_YrALL_Comp = NULL,
			NatRate_YrALL_RetPer = NULL,
			NatRate_YrALL_Ach = NR_YRA.BMAchFrameTimely,
			NatRate_YrALL_AchPer = CAST ( NR_YRA.BMAchFrameTimelyLeave AS FLOAT ) / 100.00,
			NatRate_YrGFE_Leave = NR_YRG.BMLeave,
			NatRate_YrGFE_Comp = NULL,
			NatRate_YrGFE_RetPer = NULL,
			NatRate_YrGFE_Ach = NR_YRG.BMAchFrameTimely,
			NatRate_YrGFE_AchPer = CAST ( NR_YRG.BMAchFrameTimelyLeave AS FLOAT ) / 100.00,
			NatRate_Aim_Leave = NR_FW.BMLeave,
			NatRate_Aim_Comp = NULL,
			NatRate_Aim_RetPer = NULL,
			NatRate_Aim_Ach = NR_FW.BMAchFrameTimely,
			NatRate_Aim_AchPer = CAST ( NR_FW.BMAchFrameTimelyLeave AS FLOAT ) / 100.00,
			NatRate_FworkPTSSA_Leave = NR_FWPGSSA.BMLeave,
			NatRate_FworkPTSSA_Comp = NULL,
			NatRate_FworkPTSSA_RetPer = NULL,
			NatRate_FworkPTSSA_Ach = NR_FWPGSSA.BMAchFrameTimely,
			NatRate_FworkPTSSA_AchPer = CAST ( NR_FWPGSSA.BMAchFrameTimelyLeave AS FLOAT ) / 100.00,
			NatRate_Age_Leave = NR_AGE.BMLeave,
			NatRate_Age_Comp = NULL,
			NatRate_Age_RetPer = NULL,
			NatRate_Age_Ach = NR_AGE.BMAchFrameTimely,
			NatRate_Age_AchPer = CAST ( NR_AGE.BMAchFrameTimelyLeave AS FLOAT ) / 100.00,
			NatRate_Gender_Leave = NR_GEN.BMLeave,
			NatRate_Gender_Comp = NULL,
			NatRate_Gender_RetPer = NULL,
			NatRate_Gender_Ach = NR_GEN.BMAchFrameTimely,
			NatRate_Gender_AchPer = CAST ( NR_GEN.BMAchFrameTimelyLeave AS FLOAT ) / 100.00,
			NatRate_GenderAge_Leave = NR_GENAGE.BMLeave,
			NatRate_GenderAge_Comp = NULL,
			NatRate_GenderAge_RetPer = NULL,
			NatRate_GenderAge_Ach = NR_GENAGE.BMAchFrameTimely,
			NatRate_GenderAge_AchPer = CAST ( NR_GENAGE.BMAchFrameTimelyLeave AS FLOAT ) / 100.00,
			NatRate_Level_Leave = NR_LEV.BMLeave,
			NatRate_Level_Comp = NULL,
			NatRate_Level_RetPer = NULL,
			NatRate_Level_Ach = NR_LEV.BMAchFrameTimely,
			NatRate_Level_AchPer = CAST ( NR_LEV.BMAchFrameTimelyLeave AS FLOAT ) / 100.00,
            NatRate_LevelAge_Leave = NR_LEVAGE.BMLeave,
			NatRate_LevelAge_Comp = NULL,
			NatRate_LevelAge_RetPer = NULL,
			NatRate_LevelAge_Ach = NR_LEVAGE.BMAchFrameTimely,
			NatRate_LevelAge_AchPer = CAST ( NR_LEVAGE.BMAchFrameTimelyLeave AS FLOAT ) / 100.00,
            NatRate_LevelGrp_Leave = NULL,
			NatRate_LevelGrp_Comp = NULL,
			NatRate_LevelGrp_RetPer = NULL,
			NatRate_LevelGrp_Ach = NULL,
			NatRate_LevelGrp_AchPer = NULL,
            NatRate_LevelGrpAge_Leave = NULL,
			NatRate_LevelGrpAge_Comp = NULL,
			NatRate_LevelGrpAge_RetPer = NULL,
			NatRate_LevelGrpAge_Ach = NULL,
			NatRate_LevelGrpAge_AchPer = NULL,
			NatRate_QualType_Leave = NULL,
			NatRate_QualType_Comp = NULL,
			NatRate_QualType_RetPer = NULL,
			NatRate_QualType_Ach = NULL,
			NatRate_QualType_AchPer = NULL,
			NatRate_QualTypeAge_Leave = NULL,
			NatRate_QualTypeAge_Comp = NULL,
			NatRate_QualTypeAge_RetPer = NULL,
			NatRate_QualTypeAge_Ach = NULL,
			NatRate_QualTypeAge_AchPer = NULL,
			NatRate_Ethnicity_Leave = NR_ETH.BMLeave,
			NatRate_Ethnicity_Comp = NULL,
			NatRate_Ethnicity_RetPer = NULL,
			NatRate_Ethnicity_Ach = NR_ETH.BMAchFrameTimely,
			NatRate_Ethnicity_AchPer = CAST ( NR_ETH.BMAchFrameTimelyLeave AS FLOAT ) / 100.00,
            NatRate_EthnicityAge_Leave = NR_ETHAGE.BMLeave,
			NatRate_EthnicityAge_Comp = NULL,
			NatRate_EthnicityAge_RetPer = NULL,
			NatRate_EthnicityAge_Ach = NR_ETHAGE.BMAchFrameTimely,
			NatRate_EthnicityAge_AchPer = CAST ( NR_ETHAGE.BMAchFrameTimelyLeave AS FLOAT ) / 100.00,
			NatRate_EthnicGroup_Leave = NULL,
			NatRate_EthnicGroup_Comp = NULL,
			NatRate_EthnicGroup_RetPer = NULL,
			NatRate_EthnicGroup_Ach = NULL,
			NatRate_EthnicGroup_AchPer = NULL,
            NatRate_EthnicGroupAge_Leave = NULL,
			NatRate_EthnicGroupAge_Comp = NULL,
			NatRate_EthnicGroupAge_RetPer = NULL,
			NatRate_EthnicGroupAge_Ach = NULL,
			NatRate_EthnicGroupAge_AchPer = NULL,
			NatRate_SSA1_Leave = NR_SSA1.BMLeave,
			NatRate_SSA1_Comp = NULL,
			NatRate_SSA1_RetPer = NULL,
			NatRate_SSA1_Ach = NR_SSA1.BMAchFrameTimely,
			NatRate_SSA1_AchPer = CAST ( NR_SSA1.BMAchFrameTimelyLeave AS FLOAT ) / 100.00,
			NatRate_SSA1Age_Leave = NR_SSA1AGE.BMLeave,
			NatRate_SSA1Age_Comp = NULL,
			NatRate_SSA1Age_RetPer = NULL,
			NatRate_SSA1Age_Ach = NR_SSA1AGE.BMAchFrameTimely,
			NatRate_SSA1Age_AchPer = CAST ( NR_SSA1AGE.BMAchFrameTimelyLeave AS FLOAT ) / 100.00,
			NatRate_SSA2_Leave = NR_SSA2.BMLeave,
			NatRate_SSA2_Comp = NULL,
			NatRate_SSA2_RetPer = NULL,
			NatRate_SSA2_Ach = NR_SSA2.BMAchFrameTimely,
			NatRate_SSA2_AchPer = CAST ( NR_SSA2.BMAchFrameTimelyLeave AS FLOAT ) / 100.00,
			NatRate_SSA2Age_Leave = NR_SSA2AGE.BMLeave,
			NatRate_SSA2Age_Comp = NULL,
			NatRate_SSA2Age_RetPer = NULL,
			NatRate_SSA2Age_Ach = NR_SSA2AGE.BMAchFrameTimely,
			NatRate_SSA2Age_AchPer = CAST ( NR_SSA2AGE.BMAchFrameTimelyLeave AS FLOAT ) / 100.00,
			NatRate_DifDis_Leave = NR_DIF.BMLeave,
			NatRate_DifDis_Comp = NULL,
			NatRate_DifDis_RetPer = NULL,
			NatRate_DifDis_Ach = NR_DIF.BMAchFrameTimely,
			NatRate_DifDis_AchPer = CAST ( NR_DIF.BMAchFrameTimelyLeave AS FLOAT ) / 100.00,
            NatRate_DifDisAge_Leave = NR_DIFAGE.BMLeave,
			NatRate_DifDisAge_Comp = NULL,
			NatRate_DifDisAge_RetPer = NULL,
			NatRate_DifDisAge_Ach = NR_DIFAGE.BMAchFrameTimely,
			NatRate_DifDisAge_AchPer = CAST ( NR_DIFAGE.BMAchFrameTimelyLeave AS FLOAT ) / 100.00
	'

    SET @SQLString += 
        N'
		FROM ' + @ProAchieveDatabaseLocation + 'ER_StudentProgram ER
		INNER JOIN ' + @ProAchieveDatabaseLocation + 'PG_AcademicYear AY
			ON AY.AcademicYearNumber = ER.AcademicYearNumber
		INNER JOIN ' + @ProAchieveDatabaseLocation + 'vER_MYS_RDS_Seln MYS
			ON MYS.ER_MYSID = ER.ER_MYSID
            --AND MYS.DefaultSummary = 1
            AND MYS.IsArchived = 0
            -- AND MYS.IsQSRSummary = 0
            --AND MYS.RulesApplied = 0
            --AND MYS.IncludeAllAimTypes = 1
            AND MYS.LastAcademicYearID = (
                SELECT 
                    MaxYear = MAX ( MYS2.LastAcademicYearID )
                FROM ' + @ProAchieveDatabaseLocation + 'vER_MYS_RDS_Seln MYS2
                WHERE
                    MYS2.DefaultSummary = MYS.DefaultSummary
                    AND MYS2.IsArchived = MYS.IsArchived
                    AND MYS2.IsQSRSummary = MYS.IsQSRSummary
                    AND MYS2.RulesApplied = MYS.RulesApplied
                    AND MYS2.IncludeAllAimTypes = MYS.IncludeAllAimTypes
            )
		INNER JOIN ' + @ProGeneralDatabaseLocation + 'Student STU
			ON STU.StudentID = ER.PG_StudentID
			AND STU.AcademicYearID = AY.PG_AcademicYearID
		LEFT JOIN ' + @ProAchieveDatabaseLocation + 'GN_Aim AIM 
			ON AIM.GN_AimID = ER.PG_AimID
		INNER JOIN ' + @ProAchieveDatabaseLocation + 'PG_Ethnicity ETH
			ON ETH.PG_EthnicityID = ER.PG_EthnicityID
		INNER JOIN ' + @ProAchieveDatabaseLocation + 'PG_EthnicityGroupQAR ETHQ
			ON ETHQ.PG_EthnicityGroupQARID = ETH.PG_EthnicityGroupQARID
		INNER JOIN ' + @ProAchieveDatabaseLocation + 'PG_EthnicGroup ETHG
			ON ETHG.PG_EthnicGroupID = ER.PG_EthnicGroupID
		INNER JOIN ' + @ProAchieveDatabaseLocation + 'PG_EthnicGroupSimple ETHGS
			ON ETHGS.PG_EthnicGroupSimpleID = ETHG.PG_EthnicGroupSimpleID
		INNER JOIN ' + @ProGeneralDatabaseLocation + 'SSA1 SSA1 
			ON SSA1.SSA_Tier1_code = ER.PG_SSA1ID
		INNER JOIN ' + @ProGeneralDatabaseLocation + 'SSA2 SSA2 
			ON SSA2.SSA_Tier2_code = ER.PG_SSA2ID
	'

    SET @SQLString += 
        N'
		INNER JOIN ' + @ProAchieveDatabaseLocation + 'WB_Duration DUR
			ON DUR.WB_DurationID = ER.WB_DurationID
		INNER JOIN ' + @ProAchieveDatabaseLocation + 'PG_ProgType PT
			ON PT.PG_ProgTypeID = ER.PG_ProgTypeID
		INNER JOIN ' + @ProAchieveDatabaseLocation + 'WB_ProgGroup PG
			ON PG.WB_ProgGroupID = PT.WB_ProgGroupID
		LEFT JOIN ' + @ProAchieveDatabaseLocation + 'PG_AppStandard STD
			ON STD.PG_AppStandardID = ER.PG_AppStandardID
		LEFT JOIN ' + @ProAchieveDatabaseLocation + 'PG_Framework FWK
			ON FWK.PG_FrameworkID = ER.PG_FrameworkID
		LEFT JOIN ' + @ProAchieveDatabaseLocation + 'Minimum_Standards_Group MSTD
			ON MSTD.Minimum_Standards_GroupID = ER.Minimum_Standards_GroupID
		LEFT JOIN ' + @ProAchieveDatabaseLocation + 'PG_WBLFundAgeGroup AGE 
			ON AGE.PG_WBLFundAgeGroupID = ER.PG_WBLFundAgeGroupID
		LEFT JOIN ' + @ProAchieveDatabaseLocation + 'PG_QualSize QS
			ON QS.PG_QualSizeID = ER.PG_QualSizeID
		LEFT JOIN ' + @ProAchieveDatabaseLocation + 'PM_MS_ThresholdValue MINS
			ON MINS.PG_QualSizeID = ER.PG_QualSizeID
			AND MINS.ThresholdID = 1
		LEFT JOIN ' + @ProAchieveDatabaseLocation + 'PG_Learner_FAM_Pivoted FAM
			ON FAM.PG_StudentID = ER.PG_StudentID
			AND FAM.PG_ProviderID = ER.PG_ProviderID
			AND FAM.PG_AcademicYearID = ER.PG_ExpEndYrID
		LEFT JOIN ' + @ProAchieveDatabaseLocation + 'PG_NVQLevelCPR NVQ 
			ON NVQ.PG_NVQLevelCPRID = ER.PG_NVQLevelID
		LEFT JOIN ' + @ProAchieveDatabaseLocation + 'NVQLevelGroup NVQG
			ON NVQG.NVQLevelGroupID = ER.PG_NVQLevelGroupID
		LEFT JOIN ' + @ProAchieveDatabaseLocation + 'GN_Structure1IY L1 
			ON L1.GN_Structure1IYID = ER.PG_Structure1ID
			AND L1.PG_AcademicYearID = AY.PG_AcademicYearID
		LEFT JOIN ' + @ProAchieveDatabaseLocation + 'GN_Structure2IY L2
			ON L2.GN_Structure2IYID = ER.PG_Structure2ID
			AND L2.PG_AcademicYearID = AY.PG_AcademicYearID
		LEFT JOIN ' + @ProAchieveDatabaseLocation + 'GN_Structure3IY L3
			ON L3.GN_Structure3IYID = ER.PG_Structure3ID
			AND L3.PG_AcademicYearID = AY.PG_AcademicYearID
		LEFT JOIN ' + @ProAchieveDatabaseLocation + 'GN_Structure4IY L4
			ON L4.GN_Structure4IYID = ER.PG_Structure4ID
			AND L4.PG_AcademicYearID = AY.PG_AcademicYearID
		--LEFT JOIN ProAchieve.dbo.GN_CourseStructureIY CRS 
		--	ON CRS.PG_CourseID = ER.PG_AggCourseID
		--	AND CRS.PG_AcademicYearID = ER.PG_ExpEndYrID
		LEFT JOIN ' + @ProAchieveDatabaseLocation + 'PG_AggCourse CRS 
			ON CRS.PG_AggCourseID = ER.PG_AggCourseID
		LEFT JOIN ' + @ProGeneralDatabaseLocation + 'DifficultyOrDisability DIF
			ON DIF.DifficultyOrDisabilityID = ER.PG_DifficultyOrDisabilityID
		LEFT JOIN ' + @ProGeneralDatabaseLocation + 'Enrolment_Attendance ATT 
			ON ATT.StudentID = ER.PG_StudentID
			AND ATT.CollegeID = ER.PG_ProviderID
			AND ATT.AcademicYearID = ER.PG_ExpEndYrID
			AND ATT.SequenceNo = ER.SequenceNo
		LEFT JOIN ' + @ProGeneralDatabaseLocation + 'Student_UDF LAC
			ON LAC.StudentID = ER.PG_StudentID
			AND LAC.CollegeID = ER.PG_ProviderID
			AND LAC.AcademicYearID = ER.PG_ExpEndYrID
	'

    SET @SQLString += 
        N'
		LEFT JOIN (
			SELECT
				PG_ExpEndYrID = MAX ( NR.PG_ExpEndYrID )
			FROM ' + @ProAchieveDatabaseLocation + 'PG_NationalRates_APP_Demo_Timely NR
			WHERE
				NR.PG_CollegeTypeID = @CollegeType
		) NR_L
			ON 1 = 1
		LEFT JOIN ' + @ProAchieveDatabaseLocation + 'PG_NationalRates_APP_Demo_Timely NR_YR
			ON 
				CASE
					WHEN ER.PG_ExpEndYrID >= NR_L.PG_ExpEndYrID THEN
						CASE
							WHEN NR_YR.PG_ExpEndYrID = NR_L.PG_ExpEndYrID THEN 1
							ELSE 0 
						END
					ELSE 
						CASE
							WHEN ER.PG_ExpEndYrID = NR_YR.PG_ExpEndYrID THEN 1
							ELSE 0 
						END
				END = 1
			AND NR_YR.PG_CollegeTypeID = @CollegeType
			AND NR_YR.PG_WBLFundAgeGroupID IS NULL
			AND NR_YR.PG_SSA1ID IS NULL
			AND NR_YR.PG_SSA2ID IS NULL
			AND NR_YR.PG_ProgTypeID IS NULL
			AND NR_YR.PG_EthnicityID IS NULL
			AND NR_YR.PG_EthnicityGroupQARID IS NULL
			AND NR_YR.PG_SexID IS NULL
			AND NR_YR.PG_DifficultyorDisabilityID IS NULL
			AND NR_YR.PG_LearningDifficultyID IS NULL
		LEFT JOIN ' + @ProAchieveDatabaseLocation + 'PG_NationalRates_APP_Demo_Timely NR_YRA
			ON 
				CASE
					WHEN ER.PG_ExpEndYrID >= NR_L.PG_ExpEndYrID THEN
						CASE
							WHEN NR_YRA.PG_ExpEndYrID = NR_L.PG_ExpEndYrID THEN 1
							ELSE 0 
						END
					ELSE 
						CASE
							WHEN ER.PG_ExpEndYrID = NR_YRA.PG_ExpEndYrID THEN 1
							ELSE 0 
						END
				END = 1
			AND NR_YRA.PG_CollegeTypeID = 0
			AND NR_YRA.PG_WBLFundAgeGroupID IS NULL
			AND NR_YRA.PG_SSA1ID IS NULL
			AND NR_YRA.PG_SSA2ID IS NULL
			AND NR_YRA.PG_ProgTypeID IS NULL
			AND NR_YRA.PG_EthnicityID IS NULL
			AND NR_YRA.PG_EthnicityGroupQARID IS NULL
			AND NR_YRA.PG_SexID IS NULL
			AND NR_YRA.PG_DifficultyorDisabilityID IS NULL
			AND NR_YRA.PG_LearningDifficultyID IS NULL
		LEFT JOIN ' + @ProAchieveDatabaseLocation + 'PG_NationalRates_APP_Demo_Timely NR_YRG
			ON 
				CASE
					WHEN ER.PG_ExpEndYrID >= NR_L.PG_ExpEndYrID THEN
						CASE
							WHEN NR_YRG.PG_ExpEndYrID = NR_L.PG_ExpEndYrID THEN 1
							ELSE 0 
						END
					ELSE 
						CASE
							WHEN ER.PG_ExpEndYrID = NR_YRG.PG_ExpEndYrID THEN 1
							ELSE 0 
						END
				END = 1
			AND NR_YRG.PG_CollegeTypeID = 2
			AND NR_YRG.PG_WBLFundAgeGroupID IS NULL
			AND NR_YRG.PG_SSA1ID IS NULL
			AND NR_YRG.PG_SSA2ID IS NULL
			AND NR_YRG.PG_ProgTypeID IS NULL
			AND NR_YRG.PG_EthnicityID IS NULL
			AND NR_YRG.PG_EthnicityGroupQARID IS NULL
			AND NR_YRG.PG_SexID IS NULL
			AND NR_YRG.PG_DifficultyorDisabilityID IS NULL
			AND NR_YRG.PG_LearningDifficultyID IS NULL
		LEFT JOIN ' + @ProAchieveDatabaseLocation + 'PG_NationalRates_APP_Fwrk_Timely NR_FW
			ON CASE
					WHEN ER.PG_ExpEndYrID >= NR_L.PG_ExpEndYrID THEN
						CASE
							WHEN NR_FW.PG_ExpEndYrID = NR_L.PG_ExpEndYrID THEN 1
							ELSE 0 
						END
					ELSE 
						CASE
							WHEN ER.PG_ExpEndYrID = NR_FW.PG_ExpEndYrID THEN 1
							ELSE 0 
						END
				END = 1
			AND NR_FW.PG_CollegeTypeID = @CollegeType
			AND NR_FW.PG_WBLFundAgeGroupID IS NULL
			AND NR_FW.PG_SSA1ID IS NULL
			AND NR_FW.PG_SSA2ID IS NULL
			AND NR_FW.PG_ProgTypeID IS NULL
			AND NR_FW.PG_FrameworkID = ER.PG_FrameworkID
			AND NR_FW.PG_AppStandardID IS NULL
    '

    SET @SQLString += 
        N'
		LEFT JOIN ' + @ProAchieveDatabaseLocation + 'PG_NationalRates_APP_Fwrk_Timely NR_FWPGSSA 
			ON CASE
					WHEN ER.PG_ExpEndYrID >= NR_L.PG_ExpEndYrID THEN
						CASE
							WHEN NR_FWPGSSA.PG_ExpEndYrID = NR_L.PG_ExpEndYrID THEN 1
							ELSE 0 
						END
					ELSE 
						CASE
							WHEN ER.PG_ExpEndYrID = NR_FWPGSSA.PG_ExpEndYrID THEN 1
							ELSE 0 
						END
				END = 1
			AND NR_FWPGSSA.PG_CollegeTypeID = @CollegeType
			AND NR_FWPGSSA.PG_WBLFundAgeGroupID IS NULL
			AND NR_FWPGSSA.PG_SSA1ID = ER.PG_SSA1ID
			AND NR_FWPGSSA.PG_SSA2ID = ER.PG_SSA2ID
			AND NR_FWPGSSA.PG_ProgTypeID = ER.PG_ProgTypeID
			AND NR_FWPGSSA.PG_FrameworkID = ER.PG_FrameworkID
			AND NR_FWPGSSA.PG_AppStandardID IS NULL
		LEFT JOIN ' + @ProAchieveDatabaseLocation + 'PG_NationalRates_APP_Demo_Timely NR_AGE
			ON 
				CASE
					WHEN ER.PG_ExpEndYrID >= NR_L.PG_ExpEndYrID THEN
						CASE
							WHEN NR_AGE.PG_ExpEndYrID = NR_L.PG_ExpEndYrID THEN 1
							ELSE 0 
						END
					ELSE 
						CASE
							WHEN ER.PG_ExpEndYrID = NR_AGE.PG_ExpEndYrID THEN 1
							ELSE 0 
						END
				END = 1
			AND NR_AGE.PG_CollegeTypeID = @CollegeType
			AND NR_AGE.PG_WBLFundAgeGroupID = ER.PG_WBLFundAgeGroupID
			AND NR_AGE.PG_SSA1ID IS NULL
			AND NR_AGE.PG_SSA2ID IS NULL
			AND NR_AGE.PG_ProgTypeID IS NULL
			AND NR_AGE.PG_EthnicityID IS NULL
			AND NR_AGE.PG_EthnicityGroupQARID IS NULL
			AND NR_AGE.PG_SexID IS NULL
			AND NR_AGE.PG_DifficultyorDisabilityID IS NULL
			AND NR_AGE.PG_LearningDifficultyID IS NULL
		LEFT JOIN ' + @ProAchieveDatabaseLocation + 'PG_NationalRates_APP_Demo_Timely NR_GEN
			ON 
				CASE
					WHEN ER.PG_ExpEndYrID >= NR_L.PG_ExpEndYrID THEN
						CASE
							WHEN NR_GEN.PG_ExpEndYrID = NR_L.PG_ExpEndYrID THEN 1
							ELSE 0 
						END
					ELSE 
						CASE
							WHEN ER.PG_ExpEndYrID = NR_GEN.PG_ExpEndYrID THEN 1
							ELSE 0 
						END
				END = 1
			AND NR_GEN.PG_CollegeTypeID = @CollegeType
			AND NR_GEN.PG_WBLFundAgeGroupID = ER.PG_WBLFundAgeGroupID
			AND NR_GEN.PG_SSA1ID IS NULL
			AND NR_GEN.PG_SSA2ID IS NULL
			AND NR_GEN.PG_ProgTypeID IS NULL
			AND NR_GEN.PG_EthnicityID IS NULL
			AND NR_GEN.PG_EthnicityGroupQARID IS NULL
			AND NR_GEN.PG_SexID IS NULL
			AND NR_GEN.PG_DifficultyorDisabilityID IS NULL
			AND NR_GEN.PG_LearningDifficultyID IS NULL
		LEFT JOIN ' + @ProAchieveDatabaseLocation + 'PG_NationalRates_APP_Demo_Timely NR_GENAGE
			ON 
				CASE
					WHEN ER.PG_ExpEndYrID >= NR_L.PG_ExpEndYrID THEN
						CASE
							WHEN NR_GENAGE.PG_ExpEndYrID = NR_L.PG_ExpEndYrID THEN 1
							ELSE 0 
						END
					ELSE 
						CASE
							WHEN ER.PG_ExpEndYrID = NR_GENAGE.PG_ExpEndYrID THEN 1
							ELSE 0 
						END
				END = 1
			AND NR_GENAGE.PG_CollegeTypeID = @CollegeType
			AND NR_GENAGE.PG_WBLFundAgeGroupID = ER.PG_WBLFundAgeGroupID
			AND NR_GENAGE.PG_SSA1ID IS NULL
			AND NR_GENAGE.PG_SSA2ID IS NULL
			AND NR_GENAGE.PG_ProgTypeID IS NULL
			AND NR_GENAGE.PG_EthnicityID IS NULL
			AND NR_GENAGE.PG_EthnicityGroupQARID IS NULL
			AND NR_GENAGE.PG_SexID = ER.PG_SexID
			AND NR_GENAGE.PG_DifficultyorDisabilityID IS NULL
			AND NR_GENAGE.PG_LearningDifficultyID IS NULL
	'

    SET @SQLString += 
        N'
		LEFT JOIN ' + @ProAchieveDatabaseLocation + 'PG_NationalRates_APP_Demo_Timely NR_SSA1
			ON 
				CASE
					WHEN ER.PG_ExpEndYrID >= NR_L.PG_ExpEndYrID THEN
						CASE
							WHEN NR_SSA1.PG_ExpEndYrID = NR_L.PG_ExpEndYrID THEN 1
							ELSE 0 
						END
					ELSE 
						CASE
							WHEN ER.PG_ExpEndYrID = NR_SSA1.PG_ExpEndYrID THEN 1
							ELSE 0 
						END
				END = 1
			AND NR_SSA1.PG_CollegeTypeID = @CollegeType
			AND NR_SSA1.PG_WBLFundAgeGroupID IS NULL
			AND NR_SSA1.PG_SSA1ID = ER.PG_SSA1ID
			AND NR_SSA1.PG_SSA2ID IS NULL
			AND NR_SSA1.PG_ProgTypeID IS NULL
			AND NR_SSA1.PG_EthnicityID IS NULL
			AND NR_SSA1.PG_EthnicityGroupQARID IS NULL
			AND NR_SSA1.PG_SexID IS NULL
			AND NR_SSA1.PG_DifficultyorDisabilityID IS NULL
			AND NR_SSA1.PG_LearningDifficultyID IS NULL
		LEFT JOIN ' + @ProAchieveDatabaseLocation + 'PG_NationalRates_APP_Demo_Timely NR_SSA1AGE
			ON 
				CASE
					WHEN ER.PG_ExpEndYrID >= NR_L.PG_ExpEndYrID THEN
						CASE
							WHEN NR_SSA1AGE.PG_ExpEndYrID = NR_L.PG_ExpEndYrID THEN 1
							ELSE 0 
						END
					ELSE 
						CASE
							WHEN ER.PG_ExpEndYrID = NR_SSA1AGE.PG_ExpEndYrID THEN 1
							ELSE 0 
						END
				END = 1
			AND NR_SSA1AGE.PG_CollegeTypeID = @CollegeType
			AND NR_SSA1AGE.PG_WBLFundAgeGroupID = ER.PG_WBLFundAgeGroupID
			AND NR_SSA1AGE.PG_SSA1ID = ER.PG_SSA1ID
			AND NR_SSA1AGE.PG_SSA2ID IS NULL
			AND NR_SSA1AGE.PG_ProgTypeID IS NULL
			AND NR_SSA1AGE.PG_EthnicityID IS NULL
			AND NR_SSA1AGE.PG_EthnicityGroupQARID IS NULL
			AND NR_SSA1AGE.PG_SexID IS NULL
			AND NR_SSA1AGE.PG_DifficultyorDisabilityID IS NULL
			AND NR_SSA1AGE.PG_LearningDifficultyID IS NULL
	'

    SET @SQLString += 
        N'
		LEFT JOIN ' + @ProAchieveDatabaseLocation + 'PG_NationalRates_APP_Demo_Timely NR_SSA2
			ON 
				CASE
					WHEN ER.PG_ExpEndYrID >= NR_L.PG_ExpEndYrID THEN
						CASE
							WHEN NR_SSA2.PG_ExpEndYrID = NR_L.PG_ExpEndYrID THEN 1
							ELSE 0 
						END
					ELSE 
						CASE
							WHEN ER.PG_ExpEndYrID = NR_SSA2.PG_ExpEndYrID THEN 1
							ELSE 0 
						END
				END = 1
			AND NR_SSA2.PG_CollegeTypeID = @CollegeType
			AND NR_SSA2.PG_WBLFundAgeGroupID IS NULL
			AND NR_SSA2.PG_SSA1ID IS NULL
			AND NR_SSA2.PG_SSA2ID = ER.PG_SSA2ID
			AND NR_SSA2.PG_ProgTypeID IS NULL
			AND NR_SSA2.PG_EthnicityID IS NULL
			AND NR_SSA2.PG_EthnicityGroupQARID IS NULL
			AND NR_SSA2.PG_SexID IS NULL
			AND NR_SSA2.PG_DifficultyorDisabilityID IS NULL
			AND NR_SSA2.PG_LearningDifficultyID IS NULL
		LEFT JOIN ' + @ProAchieveDatabaseLocation + 'PG_NationalRates_APP_Demo_Timely NR_SSA2AGE
			ON 
				CASE
					WHEN ER.PG_ExpEndYrID >= NR_L.PG_ExpEndYrID THEN
						CASE
							WHEN NR_SSA2AGE.PG_ExpEndYrID = NR_L.PG_ExpEndYrID THEN 1
							ELSE 0 
						END
					ELSE 
						CASE
							WHEN ER.PG_ExpEndYrID = NR_SSA2AGE.PG_ExpEndYrID THEN 1
							ELSE 0 
						END
				END = 1
			AND NR_SSA2AGE.PG_CollegeTypeID = @CollegeType
			AND NR_SSA2AGE.PG_WBLFundAgeGroupID = ER.PG_WBLFundAgeGroupID
			AND NR_SSA2AGE.PG_SSA1ID IS NULL
			AND NR_SSA2AGE.PG_SSA2ID = ER.PG_SSA2ID
			AND NR_SSA2AGE.PG_ProgTypeID IS NULL
			AND NR_SSA2AGE.PG_EthnicityID IS NULL
			AND NR_SSA2AGE.PG_EthnicityGroupQARID IS NULL
			AND NR_SSA2AGE.PG_SexID IS NULL
			AND NR_SSA2AGE.PG_DifficultyorDisabilityID IS NULL
			AND NR_SSA2AGE.PG_LearningDifficultyID IS NULL
    '

    SET @SQLString += 
        N'
		LEFT JOIN ' + @ProAchieveDatabaseLocation + 'PG_NationalRates_APP_Demo_Timely NR_LEV
			ON 
				CASE
					WHEN ER.PG_ExpEndYrID >= NR_L.PG_ExpEndYrID THEN
						CASE
							WHEN NR_LEV.PG_ExpEndYrID = NR_L.PG_ExpEndYrID THEN 1
							ELSE 0 
						END
					ELSE 
						CASE
							WHEN ER.PG_ExpEndYrID = NR_LEV.PG_ExpEndYrID THEN 1
							ELSE 0 
						END
				END = 1
			AND NR_LEV.PG_CollegeTypeID = @CollegeType
			AND NR_LEV.PG_WBLFundAgeGroupID IS NULL
			AND NR_LEV.PG_SSA1ID IS NULL
			AND NR_LEV.PG_SSA2ID IS NULL
			AND NR_LEV.PG_ProgTypeID = ER.PG_ProgTypeID
			AND NR_LEV.PG_EthnicityID IS NULL
			AND NR_LEV.PG_EthnicityGroupQARID IS NULL
			AND NR_LEV.PG_SexID IS NULL
			AND NR_LEV.PG_DifficultyorDisabilityID IS NULL
			AND NR_LEV.PG_LearningDifficultyID IS NULL
		LEFT JOIN ' + @ProAchieveDatabaseLocation + 'PG_NationalRates_APP_Demo_Timely NR_LEVAGE
			ON 
				CASE
					WHEN ER.PG_ExpEndYrID >= NR_L.PG_ExpEndYrID THEN
						CASE
							WHEN NR_LEVAGE.PG_ExpEndYrID = NR_L.PG_ExpEndYrID THEN 1
							ELSE 0 
						END
					ELSE 
						CASE
							WHEN ER.PG_ExpEndYrID = NR_LEVAGE.PG_ExpEndYrID THEN 1
							ELSE 0 
						END
				END = 1
			AND NR_LEVAGE.PG_CollegeTypeID = @CollegeType
			AND NR_LEVAGE.PG_WBLFundAgeGroupID = ER.PG_WBLFundAgeGroupID
			AND NR_LEVAGE.PG_SSA1ID IS NULL
			AND NR_LEVAGE.PG_SSA2ID IS NULL
			AND NR_LEVAGE.PG_ProgTypeID = ER.PG_ProgTypeID
			AND NR_LEVAGE.PG_EthnicityID IS NULL
			AND NR_LEVAGE.PG_EthnicityGroupQARID IS NULL
			AND NR_LEVAGE.PG_SexID IS NULL
			AND NR_LEVAGE.PG_DifficultyorDisabilityID IS NULL
			AND NR_LEVAGE.PG_LearningDifficultyID IS NULL
	'

    SET @SQLString += 
        N'
        LEFT JOIN ' + @ProAchieveDatabaseLocation + 'PG_NationalRates_APP_Demo_Timely NR_ETH
			ON 
				CASE
					WHEN ER.PG_ExpEndYrID >= NR_L.PG_ExpEndYrID THEN
						CASE
							WHEN NR_ETH.PG_ExpEndYrID = NR_L.PG_ExpEndYrID THEN 1
							ELSE 0 
						END
					ELSE 
						CASE
							WHEN ER.PG_ExpEndYrID = NR_ETH.PG_ExpEndYrID THEN 1
							ELSE 0 
						END
				END = 1
			AND NR_ETH.PG_CollegeTypeID = @CollegeType
			AND NR_ETH.PG_WBLFundAgeGroupID IS NULL
			AND NR_ETH.PG_SSA1ID IS NULL
			AND NR_ETH.PG_SSA2ID IS NULL
			AND NR_ETH.PG_ProgTypeID IS NULL
			AND NR_ETH.PG_EthnicityID = ER.PG_EthnicityID
			AND NR_ETH.PG_EthnicityGroupQARID IS NULL
			AND NR_ETH.PG_SexID IS NULL
			AND NR_ETH.PG_DifficultyorDisabilityID IS NULL
			AND NR_ETH.PG_LearningDifficultyID IS NULL
        LEFT JOIN ' + @ProAchieveDatabaseLocation + 'PG_NationalRates_APP_Demo_Timely NR_ETHAGE
			ON 
				CASE
					WHEN ER.PG_ExpEndYrID >= NR_L.PG_ExpEndYrID THEN
						CASE
							WHEN NR_ETHAGE.PG_ExpEndYrID = NR_L.PG_ExpEndYrID THEN 1
							ELSE 0 
						END
					ELSE 
						CASE
							WHEN ER.PG_ExpEndYrID = NR_ETHAGE.PG_ExpEndYrID THEN 1
							ELSE 0 
						END
				END = 1
			AND NR_ETHAGE.PG_CollegeTypeID = @CollegeType
			AND NR_ETHAGE.PG_WBLFundAgeGroupID = ER.PG_WBLFundAgeGroupID
			AND NR_ETHAGE.PG_SSA1ID IS NULL
			AND NR_ETHAGE.PG_SSA2ID IS NULL
			AND NR_ETHAGE.PG_ProgTypeID IS NULL
			AND NR_ETHAGE.PG_EthnicityID = ER.PG_EthnicityID
			AND NR_ETHAGE.PG_EthnicityGroupQARID IS NULL
			AND NR_ETHAGE.PG_SexID = ER.PG_SexID
			AND NR_ETHAGE.PG_DifficultyorDisabilityID IS NULL
			AND NR_ETHAGE.PG_LearningDifficultyID IS NULL
    '

    SET @SQLString += 
        N'
		LEFT JOIN ' + @ProAchieveDatabaseLocation + 'PG_NationalRates_APP_Demo_Timely NR_DIF
			ON 
				CASE
					WHEN ER.PG_ExpEndYrID >= NR_L.PG_ExpEndYrID THEN
						CASE
							WHEN NR_DIF.PG_ExpEndYrID = NR_L.PG_ExpEndYrID THEN 1
							ELSE 0 
						END
					ELSE 
						CASE
							WHEN ER.PG_ExpEndYrID = NR_DIF.PG_ExpEndYrID THEN 1
							ELSE 0 
						END
				END = 1
			AND NR_DIF.PG_CollegeTypeID = @CollegeType
			AND NR_DIF.PG_WBLFundAgeGroupID IS NULL
			AND NR_DIF.PG_SSA1ID IS NULL
			AND NR_DIF.PG_SSA2ID IS NULL
			AND NR_DIF.PG_ProgTypeID IS NULL
			AND NR_DIF.PG_EthnicityID IS NULL
			AND NR_DIF.PG_EthnicityGroupQARID IS NULL
			AND NR_DIF.PG_SexID IS NULL
			AND NR_DIF.PG_DifficultyorDisabilityID = ER.PG_DifficultyorDisabilityID
			AND NR_DIF.PG_LearningDifficultyID IS NULL
        LEFT JOIN ' + @ProAchieveDatabaseLocation + 'PG_NationalRates_APP_Demo_Timely NR_DIFAGE
			ON 
				CASE
					WHEN ER.PG_ExpEndYrID >= NR_L.PG_ExpEndYrID THEN
						CASE
							WHEN NR_DIFAGE.PG_ExpEndYrID = NR_L.PG_ExpEndYrID THEN 1
							ELSE 0 
						END
					ELSE 
						CASE
							WHEN ER.PG_ExpEndYrID = NR_DIFAGE.PG_ExpEndYrID THEN 1
							ELSE 0 
						END
				END = 1
			AND NR_DIFAGE.PG_CollegeTypeID = @CollegeType
			AND NR_DIFAGE.PG_WBLFundAgeGroupID = ER.PG_WBLFundAgeGroupID
			AND NR_DIFAGE.PG_SSA1ID IS NULL
			AND NR_DIFAGE.PG_SSA2ID IS NULL
			AND NR_DIFAGE.PG_ProgTypeID IS NULL
			AND NR_DIFAGE.PG_EthnicityID IS NULL
			AND NR_DIFAGE.PG_EthnicityGroupQARID IS NULL
			AND NR_DIFAGE.PG_SexID IS NULL
			AND NR_DIFAGE.PG_DifficultyorDisabilityID = ER.PG_DifficultyorDisabilityID
			AND NR_DIFAGE.PG_LearningDifficultyID IS NULL		
		WHERE
			ER.PG_ExpEndYrID = @AcademicYear
			--AND MYS.LastAcademicYearID = @AcademicYear
			--Default filters applied in ProAchieve
			AND ER.IsNotFundedAllYears = 0
			AND PT.WB_ProgGroupID = 1
	'

	--SELECT @SQLString AS [processing-instruction(x)] FOR XML PATH('')

	SET @SQLParams = 
        N'@ProviderRef NVARCHAR(50),
		@AcademicYear NVARCHAR(5),
	    @CollegeType INT,
		@OutputTableLocation NVARCHAR(200),
		@FacStructureLevel INT,
		@TeamStructureLevel INT,
		@CostCentreStructureLevel INT,
		@UserDefinedTrueValue NVARCHAR(50),
		@ALSUserDefinedField INT,
		@LookedAfterUserDefinedField INT,
		@CareLeaverUserDefinedField INT,
		@YoungCarerUserDefinedField INT,
		@YoungParentUserDefinedField INT';

    EXECUTE sp_executesql 
        @SQLString, 
        @SQLParams,
		@ProviderRef = @ProviderRef,
        @AcademicYear = @AcademicYear, 
        @CollegeType = @CollegeType,
		@OutputTableLocation = @OutputTableLocation,
		@FacStructureLevel = @FacStructureLevel,
		@TeamStructureLevel = @TeamStructureLevel,
		@CostCentreStructureLevel = @CostCentreStructureLevel,
		@UserDefinedTrueValue = @UserDefinedTrueValue,
		@ALSUserDefinedField = @ALSUserDefinedField,
		@LookedAfterUserDefinedField = @LookedAfterUserDefinedField,
		@CareLeaverUserDefinedField = @CareLeaverUserDefinedField,
		@YoungCarerUserDefinedField = @YoungCarerUserDefinedField,
		@YoungParentUserDefinedField = @YoungParentUserDefinedField;

	SET @NumRowsChanged = @@ROWCOUNT
	SET @ErrorCode = @@ERROR
END